
{% extends 'User/homeindex.html' %}
{% block body %}
{% load static %}

<html >
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <title>Chatbot</title>
 
</head>
<body>
    <form id="chat-form" method="post">
        {% csrf_token %}
        <div class="chat-container">
            <div class="div1">
                <img id="status-image" src="{% static 'js/default.png' %}" alt="Chat status">
            </div>
            <div class="div2">
                <div class="chat-body" id="chat-body">
                    <!-- Chat messages will be dynamically added here -->
                </div>
                <div class="chat-footer">
                    <input type="text" id="user-input" name="msg" placeholder="Type your message..." autocomplete="off">
                    <button type="submit" onclick="sendMessage(event)">Send</button>
                    <img id="loading-gif" src="{% static 'js/think.gif' %}" alt="Loading..." style="width:30px; height: 30px;">
                </div>
                
            </div>
        </div>
    </form>
    
     <script>
document.getElementById("user-input").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
        event.preventDefault(); // Prevent default behavior of Enter key (e.g., form submission)
        sendMessage(event); // Call the sendMessage function
    } else {
        updateStatusImage("{% static 'js/default.png' %}"); // Update to default image while user types
    }
});

function sendMessage(event) {
    event.preventDefault(); // Prevent default form submission
    
    var userInput = document.getElementById("user-input");
    var message = userInput.value.trim();

    if (message !== "") {
        var chatBody = document.getElementById("chat-body");

        // Display the user's message
        var newMessage = document.createElement("div");
        newMessage.className = "message";
        newMessage.innerHTML = "<p class='user-message'>" + message + "</p>";
        chatBody.appendChild(newMessage);

        // Update status image to "thinking"
        updateStatusImage("{% static 'js/think.gif' %}");

        // Send the message to the server
        fetch("", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            },
            body: new URLSearchParams({
                msg: message,
            }),
        })
        .then(response => response.json())
        .then(data => {
            // Display the bot's response
            var botMessage = document.createElement("div");
            botMessage.className = "message";
            botMessage.innerHTML = "<p class='bot-message'>" + data.response + "</p>";
            chatBody.appendChild(botMessage);
            chatBody.scrollTop = chatBody.scrollHeight; // Auto-scroll to the latest message
            

            // Update status image to "speaking"
            updateStatusImage("{% static 'js/speak.gif' %}");

            // Revert to default image after 5 seconds
            setTimeout(() => {
                updateStatusImage("{% static 'js/default.png' %}");
            }, 5000);
        })
        .catch(error => {
            console.error("Error:", error);
            // Optionally, revert the status image to default on error
            updateStatusImage("{% static 'js/default.png' %}");
        });

        // Clear the input field
        userInput.value = "";
    }
}

function updateStatusImage(imagePath) {
    var statusImage = document.getElementById("status-image");
    statusImage.src = imagePath;
}

</script>
</body>
</html>
{% endblock%}